box: ruby:2.3.0

services:
  - id: postgres
    env:
      POSTGRES_PASSWORD: secret_password

build:
  steps:
    - script:
      name: Bundler setting
      code: bundle config build.nokogiri --use-system-libraries

    - bundle-install

    - rails-database-yml:
      service: postgresql-docker

    - script:
      name: Set up DB
      code: RAILS_ENV=test bundle exec rake db:schema:load

    - script:
      name: Run rspecs
      code: bundle exec rspec

  after-steps:
    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      channel: notification

deploy:
  steps:
    - heroku-deploy

    - script:
      name: Update database
      code: heroku run rake db:migrate --app $APP_NAME

  after-steps:
    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      channel: notification
